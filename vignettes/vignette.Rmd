---
title: "replicateBE"
subtitle: "Comparative BA-calculation for the EMA’s Average Bioequivalence with Expanding Limits (ABEL)"
author: "Helmut Schütz"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{replicateBE}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
suppressMessages(library(replicateBE))
```

* [Disclaimer](#disclaimer)
* [Introduction](#intro)
* [Methods](#methods)
    * [Method A](#methodA)
    * [Method B](#methodB)
    * [ABE](#ABE)
* [Tested designs](#designs)
    * [Four period (full) replicates](#per4_full)
    * [Three period (full) replicates](#per3_full)
    * [Two period (full) replicate](#per2_full)
    * [Three period (partial) replicates](#per3_part)
* [Data structure](#data_struct)
* [Notes on the methods](#notes)
    * [Estimation of intra-subject variability](#cv)
    * [Model structure](#model_struc)
    * [ABE limits, rounding issues](#BElim)
    * [Degrees of freedom, comparison of methods](#df_comp)
    * [Outlier analysis](#ola)
* [Applicability, outlook](#app_out)
* [Cross-validation](#cross)
* [Contributors](#contr)
* [Session Information](#session)

---
### Disclaimer{#disclaimer}
**Program offered for Use without any Guarantees and Absolutely No Warranty. No Liability is accepted for any Loss and Risk to Public Health Resulting from Use of this R-Code.**

### Introduction{#intro}
The library provides data sets (internal `.rda` and in CSV-format in `/extdata/`) given by Schütz _et al_.^[Schütz H, Tomashevskiy M, Labes D, Shitova A, González-de la Parra M, Fuglsang A. _Reference Datasets for Studies in a Replicate Design intended for Average Bioequivalence with Expanding Limits._ In preparation 2019.] which support users in a black-box performance qualification (PQ) of their software installations.

The methods given in the EMA’s [Q&A document](https://www.ema.europa.eu/en/documents/scientific-guideline/questions-answers-positions-specific-questions-addressed-pharmacokinetics-working-party_en.pdf) for reference-scaling according to the EMA’s [Guideline on the Investigation of Bioequivalence](https://www.ema.europa.eu/en/documents/scientific-guideline/guideline-investigation-bioequivalence-rev1_en.pdf) are implemented. Potential influence of outliers on the variability of the reference can be assessed by box plots of studentized and standardized residuals as suggested at a joint [EGA/EMA workshop](https://www.medicinesforeurope.com/wp-content/uploads/2016/03/EGA_BEQ_QA_WEB_QA_1_32.pdf).

### Methods{#methods}
#### Method A{#methodA}
A linear model of log-transformed PK responses and effects\
   _sequence_, _subject(sequence)_, _period_, _treatment_\
where all effects are fixed (_i.e._, ANOVA). Estimated via function `lm()` of library `stats`.

```
log(PK) ~ sequence + subject(sequence) + period + treatment, data = data
```

#### Method B{#methodB}
A linear model of log-transformed PK responses and effects\
   _sequence_, _subject(sequence)_, _period_, _treatment_\
where _subject(sequence)_ is a random effect and all others are fixed.

```
log(PK) ~ sequence +  period + treatment, random = ~1|subject, data = data
```
Two options are provided

1.  Estimated via function `lmer()` of library `lmerTest`. Uses Satterthwaite’s degrees of freedom.\
`method.B(..., option=1)`
2.  Estimated via function `lme()` of library `nlme`. Uses degrees of freedom equivalent to SAS’ `DDFM=CONTAIN` and Phoenix/WinNonlin’s `DF Residual`. Implicitly preferred according to the Q&A document.\
`method.B(..., option=2)`, the default.

#### ABE {#ABE}
Conventional Average Bioequivalence – optionally with tighter limits required for narrow therapeutic index drugs – can be calculated as well. The model is identical to [Method A](#methodA).

### Tested designs{#designs}
#### Four period (full) replicates{#per4_full}
Both the test and the reference treatments are administered at least once.

`TRTR | RTRT`  
`TRRT | RTTR`  
`TTRR | RRTT`  
`TRTR | RTRT | TRRT | RTTR` ^[Confounded effects (design _not recommended_).]  
`TRRT | RTTR | TTRR | RRTT` ^[Confounded effects (design _not recommended_).]

#### Three period (full) replicates{#per3_full}
The test treatment is administered at least once to ½ of the subjects and the reference treatment at least once to the respective other ½ of the subjects.

`TRT | RTR`  
`TRR | RTT`

#### Two period (full) replicate{#per2_full}
The test and reference treatments are administered once to ½ of the subjects (for the estimation of the CI). _I.e._, the first group of subjects follow a conventional 2×2×2 trial. In the second group the test and reference treatments are administered at least once to ¼ of the subjects, repectively (for the estimation of _CV~wT~_ and _CV~wR~_).

`TR | RT | TT | RR` ^[Balaam’s design (_not recommended_ due to its poor power characteristics).]

#### Three period (partial) replicates{#per3_part}
The test treatment is administered once and the reference treatment at least once.

`TRR | RTR | RRT`  
`TRR | RTR` ^[Extra-reference design; biased in the presence of period effects (design _not recommended_).]


### Data structure{#data_struct}
Columns must have the headers `subject`, `period`, `sequence`, `treatment`, `PK`, and/or `logPK`.^[Naperian logarithm (base _e_). The decadic logarithm (base 10) is not supported).] Any order of columns is acceptable. Uppercase and mixed case headers will be internally converted to lowercase headers.

| variable | format |
|-|------|
| `subject` | Integer numbers or any combination of alphanumerics (A-Z, a-z, -, _, #, 0-9) |
| `period` | Integer numbers |
| `sequence` | Contained in the [tested designs](#designs). Numbers or _e.g._, `ABAB` are not acceptable |
| `treatment` | The Test must be coded `T` and the Reference `R` |

### Notes on the methods{#notes}
#### Estimation of intra-subject variability{#cv}
The EMA proposed a linear model of log-transformed PK responses of the reference\
   _sequence_, _subject(sequence)_, _period_\
where all effects are fixed. Estimated via function `lm()` of library `stats`.
```
log(PK) ~ sequence + subject(sequence) + period, data = data$R
```
Though not stated by the EMA, for informational purposes in full replicate designs (required for the WHO) the same model is additionaly run with `data = data$T`.


#### Model structure{#model_struc}
The EMA’s models assumes equal [_sic_] intra-subject variances of Test and Reference (like in 2×2×2 trials) – even if proven false in one of the full replicate designs (were _both_ _CV~wT~_ and _CV~wR~_ can be estimated). Hence, amongst bio­statis­ticians it is called the “crippled model”.

The nested structure _subject(sequence)_ leads to an over-specificed model.^[Such a nesting is superfluous since in BE trials subjects are uniquely coded. If, say, subject `1` is allocated to sequence `TRTR` there is not “another” subject `1` allocated to sequence `RTRT`. This explains the many lines in SAS `PROC GML` given with `.` and in Phoenix/WinNonlin as `not estimable`.] The simple model\
   _sequence_, _subject_, _period_, _treatment_\
gives identical estimates of the residual variance and the treatment effect and hence, its confidence interval.

Reference-scaling is acceptable for C~max~ (immediate release products^[[EMA 2010](https://www.ema.europa.eu/en/documents/scientific-guideline/guideline-investigation-bioequivalence-rev1_en.pdf#page=17)]) and C~max~, C~max,ss~, C~τ,ss~, ~partial~AUC (modified release products^[[EMA 2014](https://www.ema.europa.eu/en/documents/scientific-guideline/guideline-pharmacokinetic-clinical-evaluation-modified-release-dosage-forms_en.pdf#page=27)]) if high variability of the reference product (_CV~wR~_ >30%) was demonstrated.

The intention to widen the limits has to be stated in the protocol and – contrary to the FDA’s RSABE – a clinical justification has to be provided.

> _Those HVDP for which a wider difference in C~max~ is considered clinically irrelevant based on a sound clinical justification can be assessed with a widened acceptance range.
> The request for widened inter­val must be prospectively specified in the protocol._
> 
> --- [BE Guideline](https://www.ema.europa.eu/en/documents/scientific-guideline/guideline-investigation-bioequivalence-rev1_en.pdf)

#### ABE limits, rounding issues{#BElim}
The limits can be expanded according to $\left[ {L,U} \right] = 100{e^{ \mp 0.760 \cdot {s_{wR}}}}$ by following these rules (based on _CV~wR~_):

* _CV~wR~_ ≤ 30%\
    Conventional limits [_L_,_U_] = 80.00 – 125.00%
* 30% < _CV~wR~_ ≤ 50%\
    Expanded limits based on _s~wR~_
* _CV~wR~_ > 50%\
    As if _CV~wR~_ = 50%, _i.e._, applying _s~wR~_ = √log(0.50^2^+1)

In order to avoid small discontinuities at _CV~wR~_ ≈ 30% and 50% (due to double rounding), the expanded limits are calculated in full numeric precision and only the CI is rounded according to the GL. Like in all methods for reference-scaling a so-called _mixed criterion_ is applied. In order to pass BE both the CI has to lie entirely within the acceptance range _and_ the PE has to lie within 80.00 – 125.00%.

#### Degrees of freedom, comparison of methods{#df_comp}
The SAS code provided by the EMA in the Q&A document does not specify how the degrees of freedom should be calculated in ‘Method B’. Hence, the default in `PROC MIXED`, namely `DDFM=CONTAIN` is applied, _i.e._, `method.B(..., option=2`). For incomplete data (missing periods) Satterthwaite’s approximation of the degrees of freedom, _i.e._, `method.B(..., option=1)` might be a better choice – if stated as such in the statistical analysis plan.

The EMA seemingly prefers ‘Method A’:

> _A simple linear mixed model, which assumes identical within-subject variability (Method B), may be acceptable as long as results obtained with the two methods do not lead to different regulatory decisions. However, in borderline cases […] additional analysis using Method A might be required._
> 
> --- [Q&A document](https://www.ema.europa.eu/en/documents/scientific-guideline/questions-answers-positions-specific-questions-addressed-pharmacokinetics-working-party_en.pdf)

The half-width of the confidence interval in log-scale allows a comparison of methods (B _v.s._ A) where a higher value _might_ point towards a more conservative decision.^[Of course, only if the GMRs are identical.] In the provided example data sets – with one exception – the con­clusion of BE (based on the mixed CI and GMR criteria) agrees between ‘Method A’ and ‘Method B’.\
However, for the highly incomplete data set 14 ‘Method B’ was _liberal_ (passing by ANOVA but failing by the mixed effects model):

```{r}
# Compare Method B acc. to the GL with Method A for all reference data sets.
ds <- substr(grep("rds", unname(unlist(data(package="replicateBE"))),
                  value=TRUE), start=1, stop=5)
for (i in seq_along(ds)) {
  A <- method.A(print=FALSE, details=TRUE, data=eval(parse(text=ds[i])))$BE
  B <- method.B(print=FALSE, details=TRUE, data=eval(parse(text=ds[i])))$BE
  r <- paste0("A ", A, ", B ", B, " \u2013 ")
  cat(paste0(ds[i], ":"), r)
  if (A == B) {
    cat("Methods agree.\n")
  } else {
    if (A == "fail" & B == "pass") {
      cat("Method A is conservative.\n")
    } else {
      cat("Method B is conservative.\n")
    }
  }
}
```

Details of data set 14:
```{r}
A  <- method.A(print=FALSE, details=TRUE, data=rds14)
B2 <- method.B(print=FALSE, details=TRUE, data=rds14, option=2)
B1 <- method.B(print=FALSE, details=TRUE, data=rds14, option=1)
# Rounding according to the GL
A[15:19]  <- round(A[15:19],  2) # all effects fixed
B1[15:19] <- round(B1[15:19], 2) # Satterthwaite's df
B2[15:19] <- round(B2[15:19], 2) # df acc. to Q&A
comp <- rbind(A[c(2, 15:23)], B1[c(2, 15:23)], B2[c(2, 15:23)])
names(comp)[c(1, 10)] <- c("Meth.", "hw")
comp$hw <- signif(comp$hw, 5)
print(comp[order(comp$BE, comp$hw, decreasing=c(FALSE, TRUE)), ],
      row.names=FALSE)
```
Both variants of ‘Method B’ are more conservative than ‘Method A’. Before rounding the confidence interval, `option=2` with 192 degrees of freedom would be more conservative (lower CL 69.21029) than `option=2` with 197.44 degrees of freedom (lower CL 69.21286). However, given the incompleteness of this data set (4 missings in period 2, 12 in period 3, and 19 in period 4), Satterthwaite’s degrees of freedom probably are the better choice.


#### Outlier analysis{#ola}
It is an open issue how outliers should be handled.

> _The applicant should justify that the calculated intra-subject variability is a reliable estimate and that it is not the result of outliers._
> 
> --- [BE Guideline](https://www.ema.europa.eu/en/documents/scientific-guideline/guideline-investigation-bioequivalence-rev1_en.pdf#page=17)

Box plots were ‘suggested’ by the author as a joke [_sic_] at the EGA/EMA workshop, being aware of their nonparametric nature and the EMA’s reluctance towards robust methods. Unfortunately, this _joke_ was included in the Q&A document.

> _[…] a study could be acceptable if the bioequivalence requirements are met both including the outlier subject (using the scaled average bioequivalence approach and the within-subject CV with this sub­ject) and after exclusion of the outlier (using the within-subject CV without this subject)._
>
> _An outlier test is not an expectation of the medicines agencies but outliers could be shown by a box plot. This would allow the medicines agencies to compare the data between them._
>
> --- [EGA/EMA workshop, Q&A](https://www.medicinesforeurope.com/wp-content/uploads/2016/03/EGA_BEQ_QA_WEB_QA_1_32.pdf)


In `method.A(..., ola=TRUE)` and `method.B(..., ola=TRUE)` the default `fence=2`^[The fences are the lowest data value still within 2×IQR of the lower quartile, and the highest value still within 2×IQR of the upper quartile, where IQR is the interquartile range (the difference between the third and first quartiles). Data outside the fences are considered outliers. Decreasing the multiplier to _e.g._, 1.5 might result in many outliers whereas increasing the multiplier in only a few.] is used (in `ABE()` assessment of outliers is not acceptable).\
With the argument `ola=TRUE` the outlier analysis is performed and additionally to the scaled limits based on the complete reference data, tighter limits are calculated based on _CV~wR~_ after exclusion of outlier(s).

### Applicability, outlook{#app_out}
The EMA’s approach of reference-scaling for highly variable drugs / drug products is currently recommended in other jurisdictions as well (_e.g._, the WHO; ASEAN States, Australia, Brazil, Egypt, the Russian Federation, the Eurasian Economic Union, the East African Community, New Zealand).

The WHO opened a [pilot phase](https://extranet.who.int/prequal/sites/default/files/documents/AUC_criteria_June2017.pdf) exploring reference-scaling for AUC (four period full replicate studies are mandatory in order to assess the variability associated with each product). It is not evident how this assessment should be done. In Population Bioequivalence (PBE) and Individual Bioequivalence (IBE) the _s~wT~_/_s~wR~_ ratio was assessed and similar variability was concluded for a ratio within 0.667 – 1.500. However, the power of comparing variabilities in a study designed to demonstrate ABE is low. This was the main reason why PBE and IBE were not implemented in regulatory practice. An alternative approach is given in the FDA’s [guidance on warfarin](https://www.accessdata.fda.gov/drugsatfda_docs/psg/Warfarin_Sodium_tab_09218_RC12-12.pdf). Variabilities are considered comparable if the upper confidence limit of _σ~wT~_/_σ~wR~_ is ≤2.5.


### Cross-validation{#cross}
Results of reference data sets agree with ones obtained in SAS (9.3, 9.4) and Phoenix/WinNonlin (6.4 – 8.1).


### Contributors{#contr}
- Helmut Schütz (Author)
- Michael Tomashevskiy (Contributor)
- Detlew Labes (Contributor)

### Session Information{#session}
Inspect this information for reproducibility. Of particular importance are the versions of R and the packages used to create this workflow. It is considered good practice to record this information with every analysis.

```{r, sessioninfo}
options(width = 100)
devtools::session_info()
```
