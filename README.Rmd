---
title: "replicateBE"
output:
  github_document:
    toc: true
    toc_depth: 4
---
<!-- README.md is generated from README.Rmd. Please edit that file
     Don't forget to change [#foo] to [#user-content-foo] in README.md -
     otherwise, the links in the TOC on GitHub will not work. -->
[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)
![active](https://www.repostatus.org/badges/latest/active.svg) ![min R](https://img.shields.io/badge/R%3E%3D-3.5.0-blue.svg) ![on CRAN](https://www.r-pkg.org/badges/version-ago/replicateBE) [![cran checks](https://cranchecks.info/badges/worst/replicateBE)](https://cran.r-project.org/web/checks/check_results_replicateBE.html) [![CRAN RStudio mirror downloads](https://cranlogs.r-pkg.org/badges/grand-total/replicateBE?color=blue)](https://r-pkg.org/pkg/replicateBE) [![CRAN RStudio mirror downloads](https://cranlogs.r-pkg.org/badges/last-month/replicateBE?color=green)](https://r-pkg.org/pkg/replicateBE) ![code size](https://img.shields.io/github/languages/code-size/Helmut01/replicateBE?color=green) ![repo size](https://img.shields.io/github/repo-size/Helmut01/replicateBE?color=yellow)

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#",
  fig.path = "man/figures/README-"
)
```
```{r, echo=FALSE}
pub <- packageDate("replicateBE", date.fields = "Date/Publication")
txt <- paste0("Version ", packageVersion("replicateBE"), " built ",
         packageDate("replicateBE", date.fields = "Built"),
         " with R ", substr(packageDescription("replicateBE", fields = "Built"), 3, 7))
if (is.na(pub)) {
  txt <- paste(txt, "\n(development version not on CRAN).")
} else {
  txt <- paste0(txt, "\n(stable release on CRAN ", pub, ").")
}
cat(txt)
```

## Comparative BA-calculation for the EMA’s Average Bioequivalence with Expanding Limits (ABEL)

## Introduction
The library provides data sets (internal `.rda` and in CSV-format in `/extdata/`) which support users in a black-box performance qualification (PQ) of their software installations. Users can perform analysis of their own data imported from CSV- and Excel-files. The methods given by the EMA in [Annex I](https://www.ema.europa.eu/en/documents/other/31-annex-i-statistical-analysis-methods-compatible-ema-bioequivalence-guideline_en.pdf "EMA/582648/2016, 21 September 2016") for reference-scaling according to the EMA’s [Guideline on the Investigation of Bioequivalence](https://www.ema.europa.eu/en/documents/scientific-guideline/guideline-investigation-bioequivalence-rev1_en.pdf "EMA, January 2010") are implemented. Potential influence of outliers on the variability of the reference can be assessed by box plots of studentized and standardized residuals as suggested at a joint [EGA/EMA workshop](https://www.medicinesforeurope.com/wp-content/uploads/2016/03/EGA_BEQ_QA_WEB_QA_1_32.pdf "London, June 2010").  
In full replicate designs the variability of test and reference treatments can be assessed by _s_~wT~/_s_~wR~ and the upper confidence limit of _σ_~wT~/_σ_~wR~ (required for the [WHO’s approach](https://extranet.who.int/prequal/sites/default/files/documents/AUC_criteria_November2018.pdf "Geneva, November 2018") for reference-scaling of _AUC_).

<small>[TOC ↩](#user-content-replicatebe)</small>

### Methods

#### Estimation of _CV_~wR~ (and _CV_~wT~ in full replicate designs)
Called internally by functions `method.A()` and `method.B()`. A linear model of log-transformed pharmacokinetic (PK) responses and effects  
    _sequence_, _subject(sequence)_, _period_\
where all effects are fixed (_i.e._, ANOVA). Estimated by the function `lm()` of library `stats`.
```{r eval=FALSE}
modCVwR <- lm(log(PK) ~ sequence + subject%in%sequence + period,
                        data = data[data$treatment == "R", ])
modCVwT <- lm(log(PK) ~ sequence + subject%in%sequence + period,
                        data = data[data$treatment == "T", ])
```

<small>[TOC ↩](#user-content-replicatebe)</small>

#### Method A
Called by function `method.A()`. A linear model of log-transformed PK responses and effects  
    _sequence_, _subject(sequence)_, _period_, _treatment_\
where all effects are fixed (_i.e._, ANOVA). Estimated by the function `lm()` of library `stats`.

```{r eval=FALSE}
modA <- lm(log(PK) ~ sequence + subject%in%sequence + period + treatment,
                     data = data)
```

<small>[TOC ↩](#user-content-replicatebe)</small>

#### Method B
Called by function `method.B()`. A linear model of log-transformed PK responses and effects  
    _sequence_, _subject(sequence)_, _period_, _treatment_\
where _subject(sequence)_ is a random effect and all others are fixed.  
Three options are provided:

* Estimated by the function `lmer()` of library `lmerTest`. `method.B(..., option = 1)` employs Satterthwaite’s approximation of the degrees of freedom equivalent to SAS’ `DDFM=SATTERTHWAITE`, Phoenix WinNonlin’s `Degrees of Freedom Satterthwaite`, and Stata’s `dfm=Satterthwaite`. Note that this is the only available approximation in SPSS.
```{r eval=FALSE}
modB <- lmer(log(PK) ~ sequence + period + treatment + (1|subject),
                       data = data)
```
* Estimated by the function `lme()` of library `nlme`. `method.B(..., option = 2)` employs degrees of freedom equivalent to SAS’ `DDFM=CONTAIN`, Phoenix WinNonlin’s `Degrees of Freedom Residual`, STATISTICA’s `GLM containment`, and Stata’s `dfm=anova`. Implicitly preferred according to the EMA’s Q&A document and hence, the default of the function.
```{r eval=FALSE}
modB <- lme(log(PK) ~ sequence +  period + treatment, random = ~1|subject,
                      data = data)
```

* Estimated by the function `lmer()` of library `lmerTest`. `method.B(..., option = 3)` employs the Kenward-Roger approximation equivalent to Stata’s `dfm=Kenward Roger (EIM)` and SAS’ `DDFM=KENWARDROGER(FIRSTORDER)` *i.e.*, based on the *expected* information matrix. Note that SAS with `DDFM=KENWARDROGER` and JMP calculate Sattertwaite’s (*sic*) degrees of freedom and apply the Kackar-Harville correction *i.e.*, based on the *observed* information matrix.

```{r eval=FALSE}
modB <- lmer(log(PK) ~ sequence + period + treatment + (1|subject),
                       data = data)
```

<small>[TOC ↩](#user-content-replicatebe)</small>

#### Average Bioequivalence
Called by function `ABE()`. The model is identical to [Method A](#method-a). Conventional BE limits (80.00 – 125.00\%) are employed by default. Tighter limits (90.00 – 111.11\%) for narrow therapeutic index drugs (EMA) or wider limits (75.00 – 133.33\%) for *C*~max~ according to the guidelines of the Gulf Cooperation Council (Bahrain, Kuwait, Oman, Qatar, Saudi Arabia, United Arab Emirates) and South Africa can be specified.

<small>[TOC ↩](#user-content-replicatebe)</small>

### Tested designs
#### Four period (full) replicates
`TRTR | RTRT`  
`TRRT | RTTR`  
`TTRR | RRTT`  
`TRTR | RTRT | TRRT | RTTR`  
`TRRT | RTTR | TTRR | RRTT`

#### Three period (full) replicates
`TRT | RTR`  
`TRR | RTT`

#### Two period (full) replicate
`TR | RT | TT | RR` <small>(Balaam’s design; *not recommended* due to poor power characteristics)</small>

#### Three period (partial) replicates
`TRR | RTR | RRT`  
`TRR | RTR` <small>(Extra-reference design; biased in the presence of period effects, *not recommended*)</small>

<small>[TOC ↩](#user-content-replicatebe)</small>

### Cross-validation
Details about the reference datasets:
```{r eval=FALSE}
help("data", package = "replicateBE")
?replicateBE::data
```
Results of the 30 reference datasets agree with ones obtained in SAS (9.4), Phoenix WinNonlin (6.4 – 8.1), STATISTICA (13), SPSS (22.0), Stata (15.0), and JMP (10.0.2): Schütz H, Tomashevskiy M, Labes D, Shitova A, González-de la Parra M, Fuglsang A. *Reference Datasets for Studies in a Replicate Design Intended for Average Bioequivalence with Expanding Limits.* AAPS J. 2020; 22(2): Article 44. [doi:10.1208/s12248-020-0427-6](https://doi.org/10.1208/s12248-020-0427-6).

<small>[TOC ↩](#user-content-replicatebe)</small>

## Examples
  - Evaluation of the internal reference dataset 01 of [Annex II](https://www.ema.europa.eu/en/documents/other/31-annex-ii-statistical-analysis-bioequivalence-study-example-data-set_en.pdf "EMA, 21 September 2016") by Method A.

```{r example1}
library(replicateBE) # attach the library
res <- method.A(verbose = TRUE, details = TRUE, print = FALSE,
                data = rds01)
cols <- c(12, 15:19)           # extract relevant columns
tmp  <- round(res[cols], 2)    # 2 decimal places acc. to the GL
tmp  <- cbind(tmp, res[20:22]) # pass|fail
print(tmp, row.names = FALSE)
```

<small>[TOC ↩](#user-content-replicatebe)</small>

  - Same dataset evaluated by Method B, Kenward-Roger approximation of degrees of freedom. Outlier assessment, recalculation of _CV_~wR~ after exclusion of outliers, new expanded limits.

```{r example2}
res  <- method.B(option = 3, ola = TRUE, verbose = TRUE, details = TRUE,
                 print = FALSE, data = rds01)
cols <- c(25, 28:29, 17:19)    # extract relevant columns
tmp  <- round(res[cols], 2)    # 2 decimal places acc. to the GL
tmp  <- cbind(tmp, res[30:32]) # pass|fail
print(tmp, row.names = FALSE)
```

<small>[TOC ↩](#user-content-replicatebe)</small>

  - Evaluation of the internal reference dataset 05 of [Shumaker and Metzler](https://doi.org/10.1177/009286159803200426) by ABE, tighter limits for the narrow therapeutic index drug phenytoin.

```{r example3}
res <- ABE(verbose = TRUE, theta1 = 0.90, details = TRUE,
           print = FALSE, data = rds05)
cols <- c(13:17)            # extract relevant columns
tmp  <- round(res[cols], 2) # 2 decimal places acc. to the GL
tmp  <- cbind(tmp, res[18]) # pass|fail
print(tmp, row.names=FALSE)
```

<small>[TOC ↩](#user-content-replicatebe)</small>

## Installation

The package requires R ≥3.5.0. However, for the Kenward-Roger approximation `method.B(..., option = 3)` R ≥3.6.0 is required.

* Install the released version from CRAN:

```{r eval = FALSE}
install.packages("replicateBE", repos = "https://cloud.r-project.org/")
```

* To use the development version, please install the released version from [CRAN](https://cran.r-project.org/package=replicateBE) first to get its dependencies right ([readxl](https://cran.r-project.org/package=readxl) ≥1.0.0, [PowerTOST](https://cran.r-project.org/package=PowerTOST) ≥1.3.3, [lmerTest](https://cran.r-project.org/package=lmerTest), [nlme](https://cran.r-project.org/package=nlme), [pbkrtest](https://cran.r-project.org/package=pbkrtest)).

    You need tools for building R packages from sources on your machine. For Windows users:\
    - Download [Rtools](https://cran.r-project.org/bin/windows/Rtools/) from CRAN and follow the suggestions of the installer.
    - Install `devtools` and build the development version by:

```{r eval = FALSE}
install.packages("devtools", repos = "https://cloud.r-project.org/")
devtools::install_github("Helmut01/replicateBE")
```

<small>[TOC ↩](#user-content-replicatebe)</small>

## Session Information
Inspect this information for reproducibility. Of particular importance are the versions of R and the packages used to create this workflow. It is considered good practice to record this information with every analysis.\
Version `r packageVersion("replicateBE")` built `r packageDate("replicateBE", date.fields = "Built")` with R `r substr(packageDescription("replicateBE", fields = "Built"), 3, 7)`.

```{r, sessioninfo}
options(width = 80)
devtools::session_info()
```

<small>[TOC ↩](#user-content-replicatebe)</small>

## Disclaimer

*Package offered for Use without any Guarantees and Absolutely No Warranty. No Liability is accepted for any Loss and Risk to Public Health Resulting from Use of this R-Code.*

<small>[TOC ↩](#user-content-replicatebe)</small>

***
